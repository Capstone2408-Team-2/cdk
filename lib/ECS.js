"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ECS = void 0;
const constructs_1 = require("constructs");
const cdk = require("aws-cdk-lib");
const ec2 = require("aws-cdk-lib/aws-ec2");
const ecs = require("aws-cdk-lib/aws-ecs");
const lambda = require("aws-cdk-lib/aws-lambda");
const sqs = require("aws-cdk-lib/aws-sqs");
const secretsmanager = require("aws-cdk-lib/aws-secretsmanager");
const eventsources = require("aws-cdk-lib/aws-lambda-event-sources");
const DynamoDB_1 = require("./DynamoDB");
const path = require("path");
class ECS extends constructs_1.Construct {
    constructor(scope, id, vpc, inboundPeerSecurityGroup, elasticache) {
        super(scope, id);
        /** EDIT THESE VARIABLES PER YOUR REQUIREMENTS HERE, THE REST OF THE CODE REMAINS THE SAME **/
        const ecrImage = "public.ecr.aws/q8e0a8z0/avery-ws-server:latest";
        const taskCpuArchitecture = ecs.CpuArchitecture.ARM64;
        /** END **/
        const secret = new secretsmanager.Secret(this, "ApiKeySecret", {
            secretName: "api-key-secret",
            generateSecretString: {
                secretStringTemplate: JSON.stringify({}),
                generateStringKey: "apiKey",
                passwordLength: 32,
            },
        });
        const dynamodb = new DynamoDB_1.DynamoDB(this, "DynamoDB", vpc);
        // Define the Dead Letter Queue (DLQ)
        const dlq = new sqs.Queue(this, "MyDLQ", {
            retentionPeriod: cdk.Duration.days(14),
        });
        const queue = new sqs.Queue(this, "EventQueueQueue", {
            visibilityTimeout: cdk.Duration.seconds(5),
            deadLetterQueue: {
                maxReceiveCount: 5, // After 5 failed attempts, the message will be moved to the DLQ
                queue: dlq,
            },
        });
        const myFunction = new lambda.Function(this, "MyFunction", {
            runtime: lambda.Runtime.NODEJS_16_X,
            handler: `index.handler`, //change index to your lamda name
            code: lambda.Code.fromAsset(path.join(__dirname, "../lambda")), // assuming your Lambda code is in the 'lambda' directory
            environment: {
                DYNAMODB_MESSAGES_TABLE_NAME: dynamodb.messagesTable.tableName,
                DYNAMODB_CHANNELS_TABLE_NAME: dynamodb.channelsTable.tableName,
            },
        });
        // Add the SQS queue as an event source for the Lambda function
        myFunction.addEventSource(new eventsources.SqsEventSource(queue));
        // Grant permissions for Lambda to write to DynamoDB table
        dynamodb.messagesTable.grantReadWriteData(myFunction);
        dynamodb.channelsTable.grantReadWriteData(myFunction);
        queue.grantSendMessages(dynamodb.ecsTaskRole);
        queue.grantConsumeMessages(myFunction);
        dlq.grantSendMessages(myFunction);
        const taskDefinition = new ecs.FargateTaskDefinition(this, "WebSocketServer-TaskDef", {
            cpu: 256,
            memoryLimitMiB: 512,
            runtimePlatform: {
                operatingSystemFamily: ecs.OperatingSystemFamily.LINUX,
                cpuArchitecture: taskCpuArchitecture,
            },
            taskRole: dynamodb.ecsTaskRole, // Assign the IAM role to the task definition
        });
        // Create a security group for the container
        const ecsSecurityGroup = new ec2.SecurityGroup(this, "ContainerFromALBSecurityGroup", {
            vpc,
            description: "Allow HTTP traffic from ALB to Containers",
            allowAllOutbound: true, // Allow outbound traffic
        });
        // Allow inbound HTTP traffic from ALB on any port
        ecsSecurityGroup.addIngressRule(inboundPeerSecurityGroup, ec2.Port.tcpRange(0, 65535), // Allow TCP traffic for ports 0-65535
        "Allow traffic from ALB to containers");
        // Add a container and redis env to the task definition
        taskDefinition.addContainer("WebSocketServer-Container", {
            image: ecs.ContainerImage.fromRegistry(ecrImage),
            memoryLimitMiB: 512,
            cpu: 256,
            portMappings: [{ containerPort: 8000 }],
            environment: {
                QUEUE_URL: queue.queueUrl,
                REDIS_ENDPOINT_ADDRESS: elasticache.redisEndpointAddress,
                REDIS_ENDPOINT_PORT: elasticache.redisEndpointPort,
                DYNAMODB_MESSAGES_TABLE_NAME: dynamodb.messagesTable.tableName,
                DYNAMODB_CHANNELS_TABLE_NAME: dynamodb.channelsTable.tableName,
            },
            logging: new ecs.AwsLogDriver({
                streamPrefix: "WebSocketServer-Container",
            }),
        });
        const cluster = new ecs.Cluster(this, "WebSocketServer-Cluster", { vpc });
        this.service = new ecs.FargateService(this, "WebSocketServer-FargateService", {
            cluster,
            taskDefinition,
            desiredCount: 2,
            assignPublicIp: false,
            securityGroups: [ecsSecurityGroup],
        });
        this.service.node.addDependency(elasticache);
        new cdk.CfnOutput(this, "ApiKeySecretArnOutput", {
            value: secret.secretArn,
            description: "The ARN of the API key secret",
            exportName: "ApiKeySecretArn",
        });
    }
}
exports.ECS = ECS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRUNTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRUNTLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUF1QztBQUN2QyxtQ0FBbUM7QUFDbkMsMkNBQTJDO0FBQzNDLDJDQUEyQztBQUMzQyxpREFBaUQ7QUFDakQsMkNBQTJDO0FBQzNDLGlFQUFpRTtBQUNqRSxxRUFBcUU7QUFFckUseUNBQXNDO0FBQ3RDLDZCQUE4QjtBQUk5QixNQUFhLEdBQUksU0FBUSxzQkFBUztJQUdoQyxZQUNFLEtBQWdCLEVBQ2hCLEVBQVUsRUFDVixHQUFhLEVBQ2Isd0JBQW1DLEVBQ25DLFdBQXdCO1FBRXhCLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsOEZBQThGO1FBQzlGLE1BQU0sUUFBUSxHQUFHLGdEQUFnRCxDQUFDO1FBQ2xFLE1BQU0sbUJBQW1CLEdBQUcsR0FBRyxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUM7UUFDdEQsV0FBVztRQUVYLE1BQU0sTUFBTSxHQUFHLElBQUksY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO1lBQzdELFVBQVUsRUFBRSxnQkFBZ0I7WUFDNUIsb0JBQW9CLEVBQUU7Z0JBQ3BCLG9CQUFvQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO2dCQUN4QyxpQkFBaUIsRUFBRSxRQUFRO2dCQUMzQixjQUFjLEVBQUUsRUFBRTthQUNuQjtTQUNGLENBQUMsQ0FBQztRQUVILE1BQU0sUUFBUSxHQUFHLElBQUksbUJBQVEsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRXJELHFDQUFxQztRQUNyQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRTtZQUN2QyxlQUFlLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ3ZDLENBQUMs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LENBQUMsaUJBQWlCO2dCQUNsRCw0QkFBNEIsRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVM7Z0JBQzlELDRCQUE0QixFQUFFLFFBQVEsQ0FBQyxhQUFhLENBQUMsU0FBUzthQUMvRDtZQUNELE9BQU8sRUFBRSxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUM7Z0JBQzVCLFlBQVksRUFBRSwyQkFBMkI7YUFDMUMsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUseUJBQXlCLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBRTFFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsY0FBYyxDQUNuQyxJQUFJLEVBQ0osZ0NBQWdDLEVBQ2hDO1lBQ0UsT0FBTztZQUNQLGNBQWM7WUFDZCxZQUFZLEVBQUUsQ0FBQztZQUNmLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLGNBQWMsRUFBRSxDQUFDLGdCQUFnQixDQUFDO1NBQ25DLENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU3QyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLHVCQUF1QixFQUFFO1lBQy9DLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUztZQUN2QixXQUFXLEVBQUUsK0JBQStCO1lBQzVDLFVBQVUsRUFBRSxpQkFBaUI7U0FDOUIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBdElELGtCQXNJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgKiBhcyBjZGsgZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgKiBhcyBlYzIgZnJvbSBcImF3cy1jZGstbGliL2F3cy1lYzJcIjtcbmltcG9ydCAqIGFzIGVjcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWVjc1wiO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gXCJhd3MtY2RrLWxpYi9hd3MtbGFtYmRhXCI7XG5pbXBvcnQgKiBhcyBzcXMgZnJvbSBcImF3cy1jZGstbGliL2F3cy1zcXNcIjtcbmltcG9ydCAqIGFzIHNlY3JldHNtYW5hZ2VyIGZyb20gXCJhd3MtY2RrLWxpYi9hd3Mtc2VjcmV0c21hbmFnZXJcIjtcbmltcG9ydCAqIGFzIGV2ZW50c291cmNlcyBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWxhbWJkYS1ldmVudC1zb3VyY2VzXCI7XG5pbXBvcnQgeyBFbGFzdGljYWNoZSB9IGZyb20gXCIuL0VsYXN0aWNhY2hlXCI7XG5pbXBvcnQgeyBEeW5hbW9EQiB9IGZyb20gXCIuL0R5bmFtb0RCXCI7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xuaW1wb3J0IHsgQ2ZuT3V0cHV0IH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyBNZXNzYWdlRGF0YUFyY2hpdmUgfSBmcm9tIFwiLi9NZXNzYWdlRGF0YUFyY2hpdmVcIjtcblxuZXhwb3J0IGNsYXNzIEVDUyBleHRlbmRzIENvbnN0cnVjdCB7XG4gIHNlcnZpY2U6IGVjcy5GYXJnYXRlU2VydmljZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgdnBjOiBlYzIuSVZwYyxcbiAgICBpbmJvdW5kUGVlclNlY3VyaXR5R3JvdXA6IGVjMi5JUGVlcixcbiAgICBlbGFzdGljYWNoZTogRWxhc3RpY2FjaGVcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIC8qKiBFRElUIFRIRVNFIFZBUklBQkxFUyBQRVIgWU9VUiBSRVFVSVJFTUVOVFMgSEVSRSwgVEhFIFJFU1QgT0YgVEhFIENPREUgUkVNQUlOUyBUSEUgU0FNRSAqKi9cbiAgICBjb25zdCBlY3JJbWFnZSA9IFwicHVibGljLmVjci5hd3MvcThlMGE4ejAvYXZlcnktd3Mtc2VydmVyOmxhdGVzdFwiO1xuICAgIGNvbnN0IHRhc2tDcHVBcmNoaXRlY3R1cmUgPSBlY3MuQ3B1QXJjaGl0ZWN0dXJlLkFSTTY0O1xuICAgIC8qKiBFTkQgKiovXG5cbiAgICBjb25zdCBzZWNyZXQgPSBuZXcgc2VjcmV0c21hbmFnZXIuU2VjcmV0KHRoaXMsIFwiQXBpS2V5U2VjcmV0XCIsIHtcbiAgICAgIHNlY3JldE5hbWU6IFwiYXBpLWtleS1zZWNyZXRcIixcbiAgICAgIGdlbmVyYXRlU2VjcmV0U3RyaW5nOiB7XG4gICAgICAgIHNlY3JldFN0cmluZ1RlbXBsYXRlOiBKU09OLnN0cmluZ2lmeSh7fSksXG4gICAgICAgIGdlbmVyYXRlU3RyaW5nS2V5OiBcImFwaUtleVwiLFxuICAgICAgICBwYXNzd29yZExlbmd0aDogMzIsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgZHluYW1vZGIgPSBuZXcgRHluYW1vREIodGhpcywgXCJEeW5hbW9EQlwiLCB2cGMpO1xuXG4gICAgLy8gRGVmaW5lIHRoZSBEZWFkIExldHRlciBRdWV1ZSAoRExRKVxuICAgIGNvbnN0IGRscSA9IG5ldyBzcXMuUXVldWUodGhpcywgXCJNeURMUVwiLCB7XG4gICAgICByZXRlbnRpb25QZXJpb2Q6IGNkay5EdXJhdGlvbi5kYXlzKDE0KSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHF1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCBcIkV2ZW50UXVldWVRdWV1ZVwiLCB7XG4gICAgICB2aXNpYmlsaXR5VGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoNSksXG4gICAgICBkZWFkTGV0dGVyUXVldWU6IHtcbiAgICAgICAgbWF4UmVjZWl2ZUNvdW50OiA1LCAvLyBBZnRlciA1IGZhaWxlZCBhdHRlbXB0cywgdGhlIG1lc3NhZ2Ugd2lsbCBiZSBtb3ZlZCB0byB0aGUgRExRXG4gICAgICAgIHF1ZXVlOiBkbHEsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgbXlGdW5jdGlvbiA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgXCJNeUZ1bmN0aW9uXCIsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xNl9YLFxuICAgICAgaGFuZGxlcjogYGluZGV4LmhhbmRsZXJgLCAvL2NoYW5nZSBpbmRleCB0byB5b3VyIGxhbWRhIG5hbWVcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL2xhbWJkYVwiKSksIC8vIGFzc3VtaW5nIHlvdXIgTGFtYmRhIGNvZGUgaXMgaW4gdGhlICdsYW1iZGEnIGRpcmVjdG9yeVxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRFlOQU1PREJfTUVTU0FHRVNfVEFCTEVfTkFNRTogZHluYW1vZGIubWVzc2FnZXNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIERZTkFNT0RCX0NIQU5ORUxTX1RBQkxFX05BTUU6IGR5bmFtb2RiLmNoYW5uZWxzVGFibGUudGFibGVOYW1lLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIEFkZCB0aGUgU1FTIHF1ZXVlIGFzIGFuIGV2ZW50IHNvdXJjZSBmb3IgdGhlIExhbWJkYSBmdW5jdGlvblxuICAgIG15RnVuY3Rpb24uYWRkRXZlbnRTb3VyY2UobmV3IGV2ZW50c291cmNlcy5TcXNFdmVudFNvdXJjZShxdWV1ZSkpO1xuXG4gICAgLy8gR3JhbnQgcGVybWlzc2lvbnMgZm9yIExhbWJkYSB0byB3cml0ZSB0byBEeW5hbW9EQiB0YWJsZVxuICAgIGR5bmFtb2RiLm1lc3NhZ2VzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKG15RnVuY3Rpb24pO1xuICAgIGR5bmFtb2RiLmNoYW5uZWxzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKG15RnVuY3Rpb24pO1xuXG4gICAgcXVldWUuZ3JhbnRTZW5kTWVzc2FnZXMoZHluYW1vZGIuZWNzVGFza1JvbGUpO1xuICAgIHF1ZXVlLmdyYW50Q29uc3VtZU1lc3NhZ2VzKG15RnVuY3Rpb24pO1xuICAgIGRscS5ncmFudFNlbmRNZXNzYWdlcyhteUZ1bmN0aW9uKTtcblxuICAgIGNvbnN0IHRhc2tEZWZpbml0aW9uID0gbmV3IGVjcy5GYXJnYXRlVGFza0RlZmluaXRpb24oXG4gICAgICB0aGlzLFxuICAgICAgXCJXZWJTb2NrZXRTZXJ2ZXItVGFza0RlZlwiLFxuICAgICAge1xuICAgICAgICBjcHU6IDI1NixcbiAgICAgICAgbWVtb3J5TGltaXRNaUI6IDUxMixcbiAgICAgICAgcnVudGltZVBsYXRmb3JtOiB7XG4gICAgICAgICAgb3BlcmF0aW5nU3lzdGVtRmFtaWx5OiBlY3MuT3BlcmF0aW5nU3lzdGVtRmFtaWx5LkxJTlVYLFxuICAgICAgICAgIGNwdUFyY2hpdGVjdHVyZTogdGFza0NwdUFyY2hpdGVjdHVyZSxcbiAgICAgICAgfSxcbiAgICAgICAgdGFza1JvbGU6IGR5bmFtb2RiLmVjc1Rhc2tSb2xlLCAvLyBBc3NpZ24gdGhlIElBTSByb2xlIHRvIHRoZSB0YXNrIGRlZmluaXRpb25cbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gQ3JlYXRlIGEgc2VjdXJpdHkgZ3JvdXAgZm9yIHRoZSBjb250YWluZXJcbiAgICBjb25zdCBlY3NTZWN1cml0eUdyb3VwID0gbmV3IGVjMi5TZWN1cml0eUdyb3VwKFxuICAgICAgdGhpcyxcbiAgICAgIFwiQ29udGFpbmVyRnJvbUFMQlNlY3VyaXR5R3JvdXBcIixcbiAgICAgIHtcbiAgICAgICAgdnBjLFxuICAgICAgICBkZXNjcmlwdGlvbjogXCJBbGxvdyBIVFRQIHRyYWZmaWMgZnJvbSBBTEIgdG8gQ29udGFpbmVyc1wiLFxuICAgICAgICBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLCAvLyBBbGxvdyBvdXRib3VuZCB0cmFmZmljXG4gICAgICB9XG4gICAgKTtcblxuICAgIC8vIEFsbG93IGluYm91bmQgSFRUUCB0cmFmZmljIGZyb20gQUxCIG9uIGFueSBwb3J0XG4gICAgZWNzU2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgIGluYm91bmRQZWVyU2VjdXJpdHlHcm91cCxcbiAgICAgIGVjMi5Qb3J0LnRjcFJhbmdlKDAsIDY1NTM1KSwgLy8gQWxsb3cgVENQIHRyYWZmaWMgZm9yIHBvcnRzIDAtNjU1MzVcbiAgICAgIFwiQWxsb3cgdHJhZmZpYyBmcm9tIEFMQiB0byBjb250YWluZXJzXCJcbiAgICApO1xuXG4gICAgLy8gQWRkIGEgY29udGFpbmVyIGFuZCByZWRpcyBlbnYgdG8gdGhlIHRhc2sgZGVmaW5pdGlvblxuICAgIHRhc2tEZWZpbml0aW9uLmFkZENvbnRhaW5lcihcIldlYlNvY2tldFNlcnZlci1Db250YWluZXJcIiwge1xuICAgICAgaW1hZ2U6IGVjcy5Db250YWluZXJJbWFnZS5mcm9tUmVnaXN0cnkoZWNySW1hZ2UpLFxuICAgICAgbWVtb3J5TGltaXRNaUI6IDUxMixcbiAgICAgIGNwdTogMjU2LFxuICAgICAgcG9ydE1hcHBpbmdzOiBbeyBjb250YWluZXJQb3J0OiA4MDAwIH1dLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUVVFVUVfVVJMOiBxdWV1ZS5xdWV1ZVVybCxcbiAgICAgICAgUkVESVNfRU5EUE9JTlRfQUREUkVTUzogZWxhc3RpY2FjaGUucmVkaXNFbmRwb2ludEFkZHJlc3MsXG4gICAgICAgIFJFRElTX0VORFBPSU5UX1BPUlQ6IGVsYXN0aWNhY2hlLnJlZGlzRW5kcG9pbnRQb3J0LFxuICAgICAgICBEWU5BTU9EQl9NRVNTQUdFU19UQUJMRV9OQU1FOiBkeW5hbW9kYi5tZXNzYWdlc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgRFlOQU1PREJfQ0hBTk5FTFNfVEFCTEVfTkFNRTogZHluYW1vZGIuY2hhbm5lbHNUYWJsZS50YWJsZU5hbWUsXG4gICAgICB9LFxuICAgICAgbG9nZ2luZzogbmV3IGVjcy5Bd3NMb2dEcml2ZXIoe1xuICAgICAgICBzdHJlYW1QcmVmaXg6IFwiV2ViU29ja2V0U2VydmVyLUNvbnRhaW5lclwiLFxuICAgICAgfSksXG4gICAgfSk7XG5cbiAgICBjb25zdCBjbHVzdGVyID0gbmV3IGVjcy5DbHVzdGVyKHRoaXMsIFwiV2ViU29ja2V0U2VydmVyLUNsdXN0ZXJcIiwgeyB2cGMgfSk7XG5cbiAgICB0aGlzLnNlcnZpY2UgPSBuZXcgZWNzLkZhcmdhdGVTZXJ2aWNlKFxuICAgICAgdGhpcyxcbiAgICAgIFwiV2ViU29ja2V0U2VydmVyLUZhcmdhdGVTZXJ2aWNlXCIsXG4gICAgICB7XG4gICAgICAgIGNsdXN0ZXIsXG4gICAgICAgIHRhc2tEZWZpbml0aW9uLFxuICAgICAgICBkZXNpcmVkQ291bnQ6IDIsXG4gICAgICAgIGFzc2lnblB1YmxpY0lwOiBmYWxzZSxcbiAgICAgICAgc2VjdXJpdHlHcm91cHM6IFtlY3NTZWN1cml0eUdyb3VwXSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5zZXJ2aWNlLm5vZGUuYWRkRGVwZW5kZW5jeShlbGFzdGljYWNoZSk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBcIkFwaUtleVNlY3JldEFybk91dHB1dFwiLCB7XG4gICAgICB2YWx1ZTogc2VjcmV0LnNlY3JldEFybixcbiAgICAgIGRlc2NyaXB0aW9uOiBcIlRoZSBBUk4gb2YgdGhlIEFQSSBrZXkgc2VjcmV0XCIsXG4gICAgICBleHBvcnROYW1lOiBcIkFwaUtleVNlY3JldEFyblwiLFxuICAgIH0pO1xuICB9XG59XG4iXX0=